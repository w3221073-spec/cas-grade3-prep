<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCAS Space Mission: Grade 3</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        :root { --primary: #6C5CE7; --secondary: #00CEC9; --accent: #FAB1A0; --dark: #2D3436; --light: #DFE6E9; --success: #00b894; --error: #d63031; }
        body { font-family: 'Verdana', sans-serif; background-color: #0c0c1e; color: white; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-image: radial-gradient(white 1px, transparent 0); background-size: 40px 40px; }
        .container { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); padding: 2rem; border-radius: 20px; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); border: 1px solid rgba(255, 255, 255, 0.18); width: 90%; max-width: 600px; text-align: center; position: relative; overflow: hidden; }
        h1 { margin-bottom: 10px; color: var(--secondary); }
        
        /* Shared UI Elements */
        button { font-family: inherit; }
        .nav-btn, .action-btn { background: var(--secondary); color: var(--dark); border: none; padding: 12px 25px; font-size: 1.1rem; border-radius: 50px; cursor: pointer; font-weight: bold; transition: 0.2s; margin: 10px; }
        .nav-btn:hover, .action-btn:hover { transform: translateY(-2px); background: #00B1AD; }
        .nav-btn:disabled { opacity: 0.5; cursor: default; transform: none; }

        /* Login Screen specific */
        #login-screen { text-align: center; padding: 20px; }
        .google-btn { background: white; color: #444; padding: 15px 30px; border-radius: 5px; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; margin: 20px auto; gap: 10px; font-size: 1rem; }
        .google-btn:hover { background: #f1f1f1; }

        /* History Table */
        #history-list { list-style: none; padding: 0; max-height: 200px; overflow-y: auto; text-align: left; margin-top: 15px; }
        .history-item { background: rgba(255,255,255,0.1); padding: 10px; margin-bottom: 5px; border-radius: 8px; display: flex; justify-content: space-between; font-size: 0.9rem; }
        .date-tag { color: var(--secondary); font-size: 0.8rem; }

        /* Existing Game Styles */
        .timer-container { width: 100%; background-color: rgba(255,255,255,0.2); height: 10px; border-radius: 5px; margin-bottom: 15px; overflow: hidden; position: relative; }
        .timer-bar { height: 100%; background-color: var(--success); width: 100%; transition: width 1s linear, background-color 0.5s; }
        .timer-text { font-size: 0.9rem; margin-bottom: 10px; font-weight: bold; color: var(--secondary); }
        .status-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-size: 1.1rem; font-weight: bold; }
        #pause-btn { background: var(--accent); color: var(--dark); border: none; padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; font-weight: bold; }
        .question-card { background: white; color: var(--dark); padding: 20px; border-radius: 15px; margin-bottom: 20px; font-size: 1.3rem; border: 4px solid var(--primary); }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        button.option { background: var(--primary); border: none; padding: 15px; color: white; font-size: 1.1rem; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.1s; }
        button.option:hover { transform: scale(1.02); background: #5649c0; }
        button.option:disabled { opacity: 0.7; cursor: not-allowed; }
        .feedback { margin-top: 15px; font-size: 1.1rem; min-height: 60px; font-weight: bold; display: flex; align-items: center; justify-content: center; white-space: pre-wrap; }
        .correct-anim { background-color: var(--success) !important; }
        .wrong-anim { background-color: var(--error) !important; }
        .hidden { display: none !important; }
        .pause-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(12, 12, 30, 0.98); z-index: 100; border-radius: 20px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        /* User Profile Tag */
        .user-tag { position: absolute; top: 15px; right: 15px; font-size: 0.8rem; color: var(--light); opacity: 0.7; }
        .logout-link { text-decoration: underline; cursor: pointer; margin-left: 5px; }
    </style>
</head>
<body>

<div class="container">
    <div id="user-display" class="user-tag hidden">
        <span id="username-span">User</span> | <span class="logout-link" onclick="logout()">Logout</span>
    </div>

    <div id="login-screen">
        <h2>üîê Space Mission Access</h2>
        <p>Identify yourself, Cadet.</p>
        <button class="google-btn" onclick="loginWithGoogle()">
            Sign in with Google
        </button>
    </div>

    <div id="home-screen" class="hidden">
        <span style="font-size: 5rem; display:block; margin-bottom: 1rem;">üöÄ</span>
        <h2>Welcome Back!</h2>
        <p>Ready for your next mission?</p>
        <button class="action-btn" id="start-mission-btn">Start Mission</button>
        <button class="action-btn" style="background: #6C5CE7; color: white;" onclick="toggleHistory()">üìä My Stats</button>
        
        <div id="history-panel" class="hidden">
            <h3>Mission Log</h3>
            <ul id="history-list">Loading data...</ul>
        </div>
    </div>

    <div id="quiz-container" class="hidden">
        <div class="status-bar">
            <span id="score-display">‚≠ê Score: 0</span>
            <span id="progress-display">Mission: 0/0</span>
            <button id="pause-btn" onclick="togglePause()">‚è∏Ô∏è Pause</button>
        </div>

        <div id="quiz-area">
            <div id="pause-screen" class="pause-overlay hidden">
                <h2>Mission Paused</h2>
                <button class="action-btn" onclick="togglePause()">‚ñ∂ Resume</button>
            </div>
            <div class="timer-text" id="timer-text">‚è±Ô∏è Oxygen Left: 60s</div>
            <div class="timer-container"><div class="timer-bar" id="timer-bar"></div></div>
            <div class="question-card"><div id="question-text">Loading...</div></div>
            <div class="options-grid" id="options-container"></div>
            <div class="feedback" id="feedback-text"></div>
            <div style="display:flex; justify-content:space-between; margin-top:20px;">
                <button id="prev-btn" class="nav-btn" onclick="prevQuestion()">&#8592; Prev</button>
                <button id="next-btn" class="nav-btn" onclick="manualNext()">Next &#8594;</button>
            </div>
        </div>

        <div id="results-area" class="hidden">
            <h2>üöÄ Mission Complete!</h2>
            <p id="final-score" style="font-size: 1.5rem;"></p>
            <p id="message"></p>
            <p style="color: var(--success); font-size: 0.9rem;">‚úÖ Data Uploaded to HQ</p>
            <button class="action-btn" onclick="location.reload()">Return to Base</button>
        </div>
    </div>
</div>

<script>
    // --- 1. FIREBASE CONFIGURATION ---
    // REPLACE THIS OBJECT WITH YOUR OWN FROM FIREBASE CONSOLE
    const firebaseConfig = {
        apiKey: "AIzaSyBQrb18KJullYToPOjwFKbJZBuNkuRP_mQ",
        authDomain: "mcas-grade3-tracker.firebaseapp.com",
        projectId: "mcas-grade3-tracker",
        storageBucket: "mcas-grade3-tracker.firebasestorage.app",
        messagingSenderId: "238267753498",
        appId: "1:238267753498:web:3b652cebbb1b5c9021dda3"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    let currentUser = null;

    // --- 2. AUTH LOGIC ---
    
    // Listen for auth state changes
    auth.onAuthStateChanged(user => {
        if (user) {
            // User is signed in.
            currentUser = user;
            document.getElementById('username-span').innerText = user.displayName || user.email;
            document.getElementById('user-display').classList.remove('hidden');
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('home-screen').classList.remove('hidden');
        } else {
            // No user is signed in.
            currentUser = null;
            document.getElementById('user-display').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('home-screen').classList.add('hidden');
            document.getElementById('quiz-container').classList.add('hidden');
        }
    });

    function loginWithGoogle() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(error => {
            alert("Login Failed: " + error.message);
        });
    }

    function logout() {
        auth.signOut();
    }

    // --- 3. DATABASE LOGIC (TRACKING) ---

    function saveScore(score, total) {
        if (!currentUser) return;
        
        db.collection('scores').add({
            uid: currentUser.uid,
            email: currentUser.email,
            score: score,
            total: total,
            date: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            console.log("Score saved!");
        }).catch(err => console.error("Error saving score:", err));
    }

    function toggleHistory() {
        const panel = document.getElementById('history-panel');
        const list = document.getElementById('history-list');
        
        if (panel.classList.contains('hidden')) {
            panel.classList.remove('hidden');
            list.innerHTML = "Loading...";
            
            // Fetch last 10 scores for this user
            db.collection('scores')
              .where("uid", "==", currentUser.uid)
              .orderBy("date", "desc")
              .limit(10)
              .get()
              .then((querySnapshot) => {
                  list.innerHTML = "";
                  if (querySnapshot.empty) {
                      list.innerHTML = "<li>No missions on record yet!</li>";
                      return;
                  }
                  querySnapshot.forEach((doc) => {
                      const data = doc.data();
                      const date = data.date ? data.date.toDate().toLocaleDateString() : "Just now";
                      const percent = Math.round((data.score / data.total) * 100);
                      
                      const li = document.createElement('li');
                      li.className = 'history-item';
                      li.innerHTML = `<span>Score: ${data.score}/${data.total} (${percent}%)</span> <span class="date-tag">${date}</span>`;
                      list.appendChild(li);
                  });
              });
        } else {
            panel.classList.add('hidden');
        }
    }

    // --- 4. GAME LOGIC (Previous Code) ---

    const sfx = {
        ctx: null,
        init: function() {
            if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            if (this.ctx.state === 'suspended') this.ctx.resume();
        },
        playTone: function(f, t, d, v=0.1) {
            if (!this.ctx) return;
            const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
            o.type = t; o.frequency.setValueAtTime(f, this.ctx.currentTime);
            g.gain.setValueAtTime(v, this.ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + d);
            o.connect(g); g.connect(this.ctx.destination); o.start(); o.stop(this.ctx.currentTime + d);
        },
        playCorrect: function() { this.init(); this.playTone(880,'sine',0.1); setTimeout(()=>this.playTone(1760,'sine',0.4),100); },
        playWrong: function() { this.init(); this.playTone(150,'sawtooth',0.3); setTimeout(()=>this.playTone(100,'sawtooth',0.3),150); },
        playLaunch: function() { this.init(); const o=this.ctx.createOscillator(); const g=this.ctx.createGain(); o.frequency.setValueAtTime(200,this.ctx.currentTime); o.frequency.exponentialRampToValueAtTime(800,this.ctx.currentTime+0.5); g.gain.linearRampToValueAtTime(0,this.ctx.currentTime+0.5); o.connect(g); g.connect(this.ctx.destination); o.start(); o.stop(this.ctx.currentTime+0.5); }
    };

    let questions = [];
    let userAnswers = [];
    let currentQ = 0;
    let timeLeft = 60;
    let timerInterval, hintInterval;
    let isPaused = false;

    // Elements
    const els = {
        home: document.getElementById('home-screen'),
        quizCont: document.getElementById('quiz-container'),
        quizArea: document.getElementById('quiz-area'),
        resultsArea: document.getElementById('results-area'),
        qText: document.getElementById('question-text'),
        opts: document.getElementById('options-container'),
        feedback: document.getElementById('feedback-text'),
        timerTxt: document.getElementById('timer-text'),
        timerBar: document.getElementById('timer-bar'),
        score: document.getElementById('score-display'),
        progress: document.getElementById('progress-display'),
        pauseBtn: document.getElementById('pause-btn'),
        pauseScrn: document.getElementById('pause-screen'),
        prev: document.getElementById('prev-btn'),
        next: document.getElementById('next-btn')
    };

    document.getElementById('start-mission-btn').addEventListener('click', () => {
        sfx.init(); sfx.playLaunch();
        els.home.classList.add('hidden');
        els.quizCont.classList.remove('hidden');
        fetchQuestions();
    });

    async function fetchQuestions() {
        try {
            els.qText.innerText = "Downloading Data...";
            const res = await fetch('questions.json');
            if (!res.ok) throw new Error("Network Error");
            questions = await res.json();
            userAnswers = new Array(questions.length).fill(null);
            initGame();
        } catch (e) { els.qText.innerText = "Error loading questions."; }
    }

    function initGame() {
        currentQ = 0;
        els.quizArea.classList.remove('hidden');
        els.resultsArea.classList.add('hidden');
        updateStats();
        loadQuestion();
    }

    function loadQuestion() {
        clearInterval(timerInterval); clearInterval(hintInterval);
        const q = questions[currentQ];
        els.qText.innerText = q.question;
        els.opts.innerHTML = '';
        els.feedback.innerText = "";
        
        const answered = userAnswers[currentQ] !== null;

        q.options.forEach((opt, idx) => {
            const btn = document.createElement('button');
            btn.className = 'option'; btn.innerText = opt;
            if (answered) {
                btn.disabled = true;
                if (idx === q.correct) btn.classList.add('correct-anim');
                if (userAnswers[currentQ] === idx && idx !== q.correct) btn.classList.add('wrong-anim');
            } else {
                btn.onclick = () => checkAnswer(idx, btn);
            }
            els.opts.appendChild(btn);
        });

        els.prev.disabled = (currentQ === 0);
        els.next.innerText = (currentQ === questions.length - 1) ? "Finish" : "Next \u2192";

        if (!answered) {
            els.timerTxt.style.visibility = 'visible'; els.timerBar.parentElement.style.visibility = 'visible';
            resetTimer();
        } else {
            els.timerTxt.style.visibility = 'hidden'; els.timerBar.parentElement.style.visibility = 'hidden';
        }
        updateStats();
    }

    function checkAnswer(sel, btn) {
        clearInterval(timerInterval);
        userAnswers[currentQ] = sel;
        Array.from(document.querySelectorAll('.option')).forEach(b => b.disabled = true);
        
        if (sel === questions[currentQ].correct) {
            sfx.playCorrect();
            btn.classList.add('correct-anim');
            els.feedback.innerText = "‚úÖ Correct!";
            els.feedback.style.color = "#00b894";
            setTimeout(autoNext, 1500);
        } else {
            sfx.playWrong();
            btn.classList.add('wrong-anim');
            let w = 30;
            els.feedback.style.color = "#fab1a0";
            els.feedback.innerText = `Hint: ${questions[currentQ].hint} (${w}s)`;
            hintInterval = setInterval(() => {
                w--;
                if (w<=0) { clearInterval(hintInterval); autoNext(); }
                else els.feedback.innerText = `Hint: ${questions[currentQ].hint} (${w}s)`;
            }, 1000);
        }
        updateStats();
    }

    function autoNext() { if(currentQ < questions.length-1) { currentQ++; loadQuestion(); } else showResults(); }
    function manualNext() { autoNext(); }
    function prevQuestion() { if(currentQ > 0) { currentQ--; loadQuestion(); } }

    function resetTimer() {
        timeLeft = 60; isPaused = false;
        els.pauseScrn.classList.add('hidden'); els.pauseBtn.innerText = "‚è∏Ô∏è Pause";
        els.timerTxt.innerText = "Oxygen: 60s"; els.timerBar.style.width="100%"; els.timerBar.style.backgroundColor="#00b894";
        timerInterval = setInterval(() => {
            timeLeft--;
            els.timerTxt.innerText = `Oxygen: ${timeLeft}s`;
            els.timerBar.style.width = `${(timeLeft/60)*100}%`;
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                sfx.playWrong();
                userAnswers[currentQ] = -1;
                els.feedback.innerText = "Time's Up!";
                setTimeout(autoNext, 2000);
            }
        }, 1000);
    }

    function togglePause() {
        isPaused = !isPaused;
        if(isPaused) { clearInterval(timerInterval); clearInterval(hintInterval); els.pauseScrn.classList.remove('hidden'); }
        else { if(userAnswers[currentQ]===null) resetTimer(); els.pauseScrn.classList.add('hidden'); }
    }

    function updateStats() {
        const score = userAnswers.filter((a,i) => a === questions[i].correct).length;
        els.score.innerText = `Score: ${score}`;
        els.progress.innerText = `Mission: ${currentQ+1}/${questions.length}`;
    }

    function showResults() {
        clearInterval(timerInterval); clearInterval(hintInterval);
        sfx.playLaunch();
        const score = userAnswers.filter((a,i) => a === questions[i].correct).length;
        
        // SAVE TO FIREBASE
        saveScore(score, questions.length);

        els.quizArea.classList.add('hidden');
        els.resultsArea.classList.remove('hidden');
        document.getElementById('final-score').innerText = `Score: ${score} / ${questions.length}`;
        document.getElementById('message').innerText = score > (questions.length*0.7) ? "Commander Status!" : "Good Practice!";
    }
</script>
</body>
</html>
