<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCAS Space Mission: Grade 3</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">

    <style>
        :root { 
            --primary: #6C5CE7; 
            --primary-dark: #5649c0;
            --secondary: #00CEC9; 
            --accent: #FAB1A0; 
            --dark: #2D3436; 
            --light: #DFE6E9; 
            --success: #00b894; 
            --error: #ff7675; 
            --card-bg: rgba(255, 255, 255, 0.95);
        }

        body { 
            font-family: 'Fredoka', sans-serif; /* Fun rounded font */
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: var(--dark); 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            background-image: 
                radial-gradient(white 2px, transparent 0),
                radial-gradient(rgba(255,255,255,.5) 1px, transparent 0);
            background-size: 50px 50px, 20px 20px;
            background-position: 0 0, 25px 25px;
        }

        .container { 
            background: var(--card-bg); 
            padding: 2rem; 
            border-radius: 30px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); 
            border: 4px solid var(--secondary); 
            width: 90%; 
            max-width: 600px; 
            text-align: center; 
            position: relative; 
            overflow: hidden; 
        }

        /* Logo Styling */
        .logo-img {
            width: 160px;
            height: auto;
            margin-bottom: 10px;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.2));
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-12px); }
            100% { transform: translateY(0px); }
        }

        h1, h2 { color: var(--primary); margin-bottom: 15px; letter-spacing: 1px; }
        p { font-size: 1.1rem; color: #636e72; line-height: 1.5; }

        /* Fun Buttons */
        .action-btn, .google-btn, .nav-btn { 
            font-family: 'Fredoka', sans-serif;
            border: none; 
            padding: 15px 30px; 
            font-size: 1.2rem; 
            border-radius: 50px; 
            cursor: pointer; 
            font-weight: 600; 
            transition: all 0.1s; 
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
            margin: 10px;
            display: inline-block;
        }

        .action-btn { background: var(--secondary); color: var(--dark); }
        .action-btn:hover { transform: translateY(-2px); filter: brightness(1.1); box-shadow: 0 6px 0 rgba(0,0,0,0.2); }
        .action-btn:active { transform: translateY(2px); box-shadow: 0 0 0; }

        .google-btn { background: white; color: #444; border: 2px solid #eee; display: flex; align-items: center; justify-content: center; gap: 10px; margin: 20px auto; }
        .google-btn:hover { background: #f1f1f1; transform: translateY(-2px); }

        input[type="text"] { 
            padding: 15px; 
            border-radius: 15px; 
            border: 3px solid var(--secondary); 
            background: #f8f9fa; 
            width: 70%; 
            font-size: 1.3rem; 
            font-family: 'Fredoka', sans-serif;
            margin-bottom: 20px; 
            text-align: center; 
            color: var(--primary);
        }
        input[type="text"]:focus { outline: none; border-color: var(--primary); }

        /* Progress Bars */
        .progress-bar-container { width: 100%; background: #dfe6e9; height: 25px; border-radius: 15px; margin: 10px 0; overflow: hidden; border: 2px solid #b2bec3; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--secondary), var(--success)); width: 0%; transition: width 1s ease; }

        /* Quiz Card */
        .question-card { 
            background: #fff; 
            color: var(--dark); 
            padding: 25px; 
            border-radius: 20px; 
            margin-bottom: 20px; 
            font-size: 1.5rem; 
            border: 3px dashed var(--primary); 
            line-height: 1.4;
        }

        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        button.option { 
            background: white; 
            border: 3px solid var(--primary); 
            padding: 15px; 
            color: var(--dark); 
            font-size: 1.2rem; 
            border-radius: 20px; 
            cursor: pointer; 
            font-family: 'Fredoka', sans-serif; 
            font-weight: 600;
            box-shadow: 0 4px 0 var(--primary); 
            transition: all 0.1s;
        }
        button.option:hover:not(:disabled) { transform: translateY(-2px); background: #eceaff; box-shadow: 0 6px 0 var(--primary); }
        button.option:active:not(:disabled) { transform: translateY(2px); box-shadow: 0 0 0; }
        
        .correct-anim { 
            background-color: var(--success) !important; 
            border-color: var(--success) !important; 
            color: white !important; 
            box-shadow: 0 4px 0 #008c72 !important;
        }
        .wrong-anim { 
            background-color: var(--error) !important; 
            border-color: var(--error) !important; 
            color: white !important; 
            box-shadow: 0 4px 0 #b71c1c !important;
        }

        .feedback { margin-top: 15px; font-size: 1.3rem; min-height: 60px; font-weight: bold; display: flex; align-items: center; justify-content: center; white-space: pre-wrap; }
        .status-bar { display: flex; justify-content: space-between; align-items: center; background: #f1f2f6; padding: 10px 15px; border-radius: 15px; margin-bottom: 20px; color: var(--primary); }

        .hidden { display: none !important; }
        .user-tag { position: absolute; top: 15px; right: 15px; font-size: 0.9rem; color: var(--dark); font-weight: bold; opacity: 0.6; cursor: pointer; }
        .user-tag:hover { opacity: 1; text-decoration: underline; }
        
        /* Timer */
        .timer-container { width: 100%; background-color: #dfe6e9; height: 12px; border-radius: 6px; margin-bottom: 15px; overflow: hidden; }
        .timer-bar { height: 100%; background-color: var(--success); width: 100%; transition: width 1s linear; }

        /* Mobile Adjustments */
        @media(max-width: 500px) {
            .options-grid { grid-template-columns: 1fr; }
            .container { padding: 1.5rem; width: 95%; }
            h1 { font-size: 1.8rem; }
        }
    </style>
</head>
<body>

<div class="container">
    <img src="logo.png" alt="MCAS Space Mission Logo" class="logo-img" onerror="this.style.display='none'">

    <div id="user-display" class="user-tag hidden" onclick="logout()">
        üë§ <span id="username-span">Cadet</span> (Logout)
    </div>

    <div id="login-screen">
        <h2>üîê Cadet Access</h2>
        <p>Sign in to save your badges and mission progress!</p>
        <button class="google-btn" onclick="loginWithGoogle()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20"> 
            Sign in with Google
        </button>
    </div>

    <div id="setup-screen" class="hidden">
        <h2>üë©‚ÄçüöÄ New Recruit!</h2>
        <p>What is your callsign, Cadet?</p>
        <input type="text" id="callsign-input" placeholder="e.g. Captain Alex" maxlength="15">
        <br>
        <button class="action-btn" onclick="saveCallsign()">Save Callsign</button>
    </div>

    <div id="home-screen" class="hidden">
        <h2 id="welcome-msg">Welcome Back!</h2>
        
        <div style="text-align: left; margin: 20px 0; background: #f8f9fa; padding: 15px; border-radius: 15px;">
            <label style="font-weight:bold; color:var(--primary);">üèÜ Total Mastery:</label>
            <div style="float:right; font-weight:bold;" id="mastery-text">0 / 1000</div>
            <div class="progress-bar-container">
                <div id="mastery-bar" class="progress-fill"></div>
            </div>
        </div>

        <p id="mission-brief" style="font-size: 1.2rem; color: var(--dark);">Ready for today's mission?</p>
        <div style="display:flex; flex-direction:column; gap:10px;">
            <button class="action-btn" id="start-mission-btn">üöÄ Start 50-Question Mission</button>
            <button class="action-btn" style="background: #ff7675; color: white; font-size: 1rem; padding: 10px 20px;" onclick="resetProgress()">üóëÔ∏è Reset Progress</button>
        </div>
    </div>

    <div id="quiz-container" class="hidden">
        <div class="status-bar">
            <span id="score-display">‚≠ê Score: 0</span>
            <span id="progress-display">Mission: 1/50</span>
            <button id="pause-btn" class="nav-btn" style="padding: 5px 15px; font-size: 0.9rem; margin:0;" onclick="togglePause()">‚è∏Ô∏è</button>
        </div>

        <div id="quiz-area">
            <div id="pause-screen" class="hidden" style="position:absolute; inset:0; background:rgba(255,255,255,0.95); z-index:10; display:flex; flex-direction:column; justify-content:center; align-items:center; border-radius:20px;">
                <h2 style="font-size:3rem;">‚è∏Ô∏è</h2>
                <h2>Mission Paused</h2>
                <button class="action-btn" onclick="togglePause()">‚ñ∂ Resume</button>
            </div>

            <div style="display:flex; justify-content:space-between; font-size:0.9rem; font-weight:bold; color:#b2bec3; margin-bottom:5px;">
                <span>Oxygen Level</span>
                <span id="timer-text">60s</span>
            </div>
            <div class="timer-container"><div class="timer-bar" id="timer-bar"></div></div>
            
            <div class="question-card">
                <div id="question-text">Loading Mission Data...</div>
            </div>
            
            <div class="options-grid" id="options-container"></div>
            <div class="feedback" id="feedback-text"></div>
            
            <div style="display:flex; justify-content:space-between; margin-top:20px;">
                <button id="prev-btn" class="nav-btn" onclick="prevQuestion()">&#8592; Prev</button>
                <button id="next-btn" class="nav-btn" onclick="manualNext()">Next &#8594;</button>
            </div>
        </div>

        <div id="results-area" class="hidden">
            <h2 style="font-size: 2.5rem;">üöÄ Mission Complete!</h2>
            <p id="final-score" style="font-size: 2rem; font-weight: bold; color: var(--primary);"></p>
            <p id="message" style="font-size: 1.4rem;"></p>
            <button class="action-btn" onclick="location.reload()">Return to Base</button>
        </div>
    </div>
</div>

<script>
    // --- 1. FIREBASE CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyBQrb18KJullYToPOjwFKbJZBuNkuRP_mQ",
        authDomain: "mcas-grade3-tracker.firebaseapp.com",
        projectId: "mcas-grade3-tracker",
        storageBucket: "mcas-grade3-tracker.firebasestorage.app",
        messagingSenderId: "238267753498",
        appId: "1:238267753498:web:3b652cebbb1b5c9021dda3"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    let currentUser = null;
    let userCallsign = "Cadet";
    let masterQuestionList = []; 
    let sessionQuestions = [];   
    let solvedIndices = [];      

// --- 2. AUTH FLOW ---
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            db.collection('users').doc(user.uid).get().then(doc => {
                // FIX: Hide login screen regardless of whether they are new or returning
                document.getElementById('login-screen').classList.add('hidden');

                if (doc.exists && doc.data().callsign) {
                    // Returning User: Load profile immediately
                    userCallsign = doc.data().callsign;
                    loadUserProfile(doc.data());
                } else {
                    // New User: Show setup screen
                    document.getElementById('setup-screen').classList.remove('hidden');
                }
            });
        } else {
            currentUser = null;
            // No user? Show login, hide everything else
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('home-screen').classList.add('hidden');
            document.getElementById('setup-screen').classList.add('hidden');
            document.getElementById('user-display').classList.add('hidden');
        }
    });

    function loginWithGoogle() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(e => alert(e.message));
    }

    function saveCallsign() {
        const input = document.getElementById('callsign-input').value.trim();
        if (input.length < 1) { alert("Please enter a name, Cadet!"); return; }
        userCallsign = input;
        db.collection('users').doc(currentUser.uid).set({
            callsign: userCallsign, email: currentUser.email
        }, { merge: true }).then(() => {
            document.getElementById('setup-screen').classList.add('hidden');
            loadUserProfile({});
        });
    }

    function logout() { auth.signOut(); location.reload(); }

    function loadUserProfile(data) {
        solvedIndices = data.mastered_ids || [];
        document.getElementById('username-span').innerText = userCallsign;
        document.getElementById('welcome-msg').innerText = `Welcome, ${userCallsign}!`;
        document.getElementById('user-display').classList.remove('hidden');
        
        fetch('questions.json').then(res => res.json()).then(data => {
            masterQuestionList = data;
            updateHomeStats();
            document.getElementById('home-screen').classList.remove('hidden');
        });
    }

    function updateHomeStats() {
        const total = masterQuestionList.length;
        const mastered = solvedIndices.length;
        const percent = Math.floor((mastered / total) * 100);
        
        document.getElementById('mastery-text').innerText = `${mastered} / ${total}`;
        document.getElementById('mastery-bar').style.width = `${percent}%`;
        
        if(mastered >= total) {
            document.getElementById('mission-brief').innerText = `üéâ Incredible work, ${userCallsign}! You've conquered the galaxy!`;
            document.getElementById('start-mission-btn').disabled = true;
        } else {
            document.getElementById('mission-brief').innerText = `${userCallsign}, ready for today's mission?`;
        }
    }

    // --- 3. SESSION SETUP ---
    document.getElementById('start-mission-btn').addEventListener('click', setupSession);

    function setupSession() {
        sfx.init(); sfx.playLaunch();
        document.getElementById('home-screen').classList.add('hidden');
        document.getElementById('quiz-container').classList.remove('hidden');

        let availableIndices = masterQuestionList.map((_, i) => i).filter(i => !solvedIndices.includes(i));
        availableIndices.sort(() => Math.random() - 0.5);
        let sessionIndices = availableIndices.slice(0, 50);

        sessionQuestions = sessionIndices.map(originalIndex => {
            let q = masterQuestionList[originalIndex];
            return { ...q, originalIndex: originalIndex }; 
        });

        userAnswers = new Array(sessionQuestions.length).fill(null);
        initGame();
    }

    // --- 4. GAME LOGIC ---
    const sfx = {
        ctx: null,
        init: function() { if (!this.ctx) this.ctx = new (window.AudioContext||window.webkitAudioContext)(); if(this.ctx.state==='suspended')this.ctx.resume(); },
        playTone: function(f,t,d) { if(!this.ctx)return; const o=this.ctx.createOscillator(),g=this.ctx.createGain(); o.type=t; o.frequency.value=f; g.gain.setValueAtTime(0.1,this.ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.001,this.ctx.currentTime+d); o.connect(g); g.connect(this.ctx.destination); o.start(); o.stop(this.ctx.currentTime+d); },
        playCorrect: function() { this.init(); this.playTone(880,'sine',0.1); setTimeout(()=>this.playTone(1760,'sine',0.2),100); },
        playWrong: function() { this.init(); this.playTone(150,'sawtooth',0.3); setTimeout(()=>this.playTone(100,'sawtooth',0.3),150); },
        playLaunch: function() { this.init(); if(!this.ctx)return; const o=this.ctx.createOscillator(),g=this.ctx.createGain(); o.frequency.setValueAtTime(200,this.ctx.currentTime); o.frequency.exponentialRampToValueAtTime(800,this.ctx.currentTime+0.5); g.gain.linearRampToValueAtTime(0,this.ctx.currentTime+0.5); o.connect(g); g.connect(this.ctx.destination); o.start(); o.stop(this.ctx.currentTime+0.5); }
    };

    let currentQ = 0;
    let timeLeft = 60;
    let timerInterval, hintInterval;
    let isPaused = false;
    let userAnswers = []; 

    const els = {
        qText: document.getElementById('question-text'),
        opts: document.getElementById('options-container'),
        feedback: document.getElementById('feedback-text'),
        timerTxt: document.getElementById('timer-text'),
        timerBar: document.getElementById('timer-bar'),
        progress: document.getElementById('progress-display'),
        score: document.getElementById('score-display'),
        prev: document.getElementById('prev-btn'),
        next: document.getElementById('next-btn'),
        pauseScrn: document.getElementById('pause-screen')
    };

    function initGame() {
        currentQ = 0;
        document.getElementById('quiz-area').classList.remove('hidden');
        document.getElementById('results-area').classList.add('hidden');
        updateStats();
        loadQuestion();
    }

    function loadQuestion() {
        clearInterval(timerInterval); clearInterval(hintInterval);
        const q = sessionQuestions[currentQ];
        els.qText.innerText = q.question;
        els.opts.innerHTML = '';
        els.feedback.innerText = "";

        const answered = userAnswers[currentQ] !== null;

        q.options.forEach((opt, idx) => {
            const btn = document.createElement('button');
            btn.className = 'option';
            btn.innerText = opt;
            if (answered) {
                btn.disabled = true;
                if (idx === q.correct) btn.classList.add('correct-anim');
                if (userAnswers[currentQ] === idx && idx !== q.correct) btn.classList.add('wrong-anim');
            } else {
                btn.onclick = () => checkAnswer(idx, btn);
            }
            els.opts.appendChild(btn);
        });

        els.prev.disabled = (currentQ === 0);
        els.next.innerText = (currentQ === sessionQuestions.length - 1) ? "Finish" : "Next \u2192";

        if (!answered) {
            resetTimer();
        }
        updateStats();
    }

    function checkAnswer(sel, btn) {
        clearInterval(timerInterval);
        userAnswers[currentQ] = sel;
        const q = sessionQuestions[currentQ];
        
        Array.from(document.querySelectorAll('.option')).forEach(b => b.disabled = true);

        if (sel === q.correct) {
            sfx.playCorrect();
            btn.classList.add('correct-anim');
            els.feedback.innerText = `‚úÖ Correct! You're a star, ${userCallsign}!`;
            els.feedback.style.color = "#00b894";
            
            db.collection('users').doc(currentUser.uid).set({
                mastered_ids: firebase.firestore.FieldValue.arrayUnion(q.originalIndex),
                last_activity: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });

            setTimeout(autoNext, 1500);
        } else {
            sfx.playWrong();
            btn.classList.add('wrong-anim');
            els.feedback.style.color = "#ff7675";
            let w = 30;
            els.feedback.innerText = `‚ö†Ô∏è Nice try, ${userCallsign}.\nHint: ${q.hint} (${w}s)`;
            hintInterval = setInterval(() => {
                w--;
                if (w<=0) { clearInterval(hintInterval); autoNext(); }
                else els.feedback.innerText = `‚ö†Ô∏è Nice try, ${userCallsign}.\nHint: ${q.hint} (${w}s)`;
            }, 1000);
        }
        updateStats();
    }

    function autoNext() { if(currentQ < sessionQuestions.length-1) { currentQ++; loadQuestion(); } else showResults(); }
    function manualNext() { autoNext(); }
    function prevQuestion() { if(currentQ > 0) { currentQ--; loadQuestion(); } }

    function resetTimer() {
        timeLeft = 60; isPaused = false;
        els.pauseScrn.classList.add('hidden');
        els.timerTxt.innerText = `${timeLeft}s`; 
        els.timerBar.style.width="100%"; els.timerBar.style.backgroundColor="#00b894";
        
        timerInterval = setInterval(() => {
            timeLeft--;
            els.timerTxt.innerText = `${timeLeft}s`;
            els.timerBar.style.width = `${(timeLeft/60)*100}%`;
            if(timeLeft < 20) els.timerBar.style.backgroundColor="#ff7675";
            
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                sfx.playWrong();
                userAnswers[currentQ] = -1; 
                els.feedback.innerText = `‚åõ Time's Up, ${userCallsign}!`;
                setTimeout(autoNext, 2000);
            }
        }, 1000);
    }

    function togglePause() {
        isPaused = !isPaused;
        if(isPaused) { 
            clearInterval(timerInterval); clearInterval(hintInterval); 
            els.pauseScrn.classList.remove('hidden'); 
        } else { 
            if(userAnswers[currentQ]===null) resetTimer(); 
            els.pauseScrn.classList.add('hidden'); 
        }
    }

    function updateStats() {
        const score = userAnswers.filter((a,i) => sessionQuestions[i] && a === sessionQuestions[i].correct).length;
        els.score.innerText = `‚≠ê Score: ${score}`;
        els.progress.innerText = `Mission: ${currentQ+1}/${sessionQuestions.length}`;
    }

    function showResults() {
        clearInterval(timerInterval); clearInterval(hintInterval);
        sfx.playLaunch();
        const score = userAnswers.filter((a,i) => a === sessionQuestions[i].correct).length;
        
        document.getElementById('quiz-area').classList.add('hidden');
        document.getElementById('results-area').classList.remove('hidden');
        document.getElementById('final-score').innerText = `Score: ${score} / ${sessionQuestions.length}`;
        
        const pct = score / sessionQuestions.length;
        let msg = `Good Practice, ${userCallsign}!`;
        if(pct > 0.8) msg = `üèÜ Commander Status! Excellent work, ${userCallsign}.`;
        else if(pct > 0.5) msg = `üöÄ Mission Accomplished. Keep training!`;
        
        document.getElementById('message').innerText = msg;
    }

    function resetProgress() {
        if(confirm("Are you sure? This will forget all questions you have mastered.")) {
            db.collection('users').doc(currentUser.uid).update({ mastered_ids: [] })
            .then(() => { alert("Memory wiped. Starting fresh."); location.reload(); });
        }
    }
</script>
</body>
</html>
