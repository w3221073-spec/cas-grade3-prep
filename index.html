<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCAS Space Mission: Grade 3</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        :root { --primary: #6C5CE7; --secondary: #00CEC9; --accent: #FAB1A0; --dark: #2D3436; --light: #DFE6E9; --success: #00b894; --error: #d63031; }
        body { font-family: 'Verdana', sans-serif; background-color: #0c0c1e; color: white; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-image: radial-gradient(white 1px, transparent 0); background-size: 40px 40px; }
        .container { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); padding: 2rem; border-radius: 20px; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); border: 1px solid rgba(255, 255, 255, 0.18); width: 90%; max-width: 600px; text-align: center; position: relative; overflow: hidden; }
        h1 { margin-bottom: 10px; color: var(--secondary); }
        
        /* Buttons & Inputs */
        .nav-btn, .action-btn { background: var(--secondary); color: var(--dark); border: none; padding: 12px 25px; font-size: 1.1rem; border-radius: 50px; cursor: pointer; font-weight: bold; transition: 0.2s; margin: 10px; }
        .nav-btn:hover, .action-btn:hover { transform: translateY(-2px); background: #00B1AD; }
        .nav-btn:disabled { opacity: 0.5; cursor: default; transform: none; }
        .google-btn { background: white; color: #444; padding: 15px 30px; border-radius: 5px; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; margin: 20px auto; gap: 10px; font-size: 1rem; }
        
        input[type="text"] { padding: 15px; border-radius: 10px; border: 2px solid var(--secondary); background: rgba(255,255,255,0.9); width: 70%; font-size: 1.2rem; margin-bottom: 20px; text-align: center; }

        /* Panels */
        .progress-bar-container { width: 100%; background: rgba(255,255,255,0.1); height: 20px; border-radius: 10px; margin: 10px 0; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--success); width: 0%; transition: width 1s ease; }

        /* Quiz UI */
        .timer-container { width: 100%; background-color: rgba(255,255,255,0.2); height: 10px; border-radius: 5px; margin-bottom: 15px; overflow: hidden; position: relative; }
        .timer-bar { height: 100%; background-color: var(--success); width: 100%; transition: width 1s linear, background-color 0.5s; }
        .timer-text { font-size: 0.9rem; margin-bottom: 10px; font-weight: bold; color: var(--secondary); }
        .status-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-size: 1.1rem; font-weight: bold; }
        .question-card { background: white; color: var(--dark); padding: 20px; border-radius: 15px; margin-bottom: 20px; font-size: 1.3rem; border: 4px solid var(--primary); }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        button.option { background: var(--primary); border: none; padding: 15px; color: white; font-size: 1.1rem; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.1s; }
        button.option:hover { transform: scale(1.02); background: #5649c0; }
        button.option:disabled { opacity: 0.7; cursor: not-allowed; }
        .feedback { margin-top: 15px; font-size: 1.1rem; min-height: 60px; font-weight: bold; display: flex; align-items: center; justify-content: center; white-space: pre-wrap; }
        .correct-anim { background-color: var(--success) !important; }
        .wrong-anim { background-color: var(--error) !important; }
        .hidden { display: none !important; }
        .pause-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(12, 12, 30, 0.98); z-index: 100; border-radius: 20px; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .user-tag { position: absolute; top: 15px; right: 15px; font-size: 0.8rem; color: var(--light); opacity: 0.7; }
        .logout-link { text-decoration: underline; cursor: pointer; margin-left: 5px; }
    </style>
</head>
<body>

<div class="container">
    <div id="user-display" class="user-tag hidden">
        <span id="username-span">User</span> | <span class="logout-link" onclick="logout()">Logout</span>
    </div>

    <div id="login-screen">
        <h2>üîê Space Mission Access</h2>
        <p>Identify yourself, Cadet.</p>
        <button class="google-btn" onclick="loginWithGoogle()">Sign in with Google</button>
    </div>

    <div id="setup-screen" class="hidden">
        <span style="font-size: 4rem;">üë©‚ÄçüöÄ</span>
        <h2>Enter Your Callsign</h2>
        <p>What should Mission Control call you?</p>
        <input type="text" id="callsign-input" placeholder="e.g. Captain Alex" maxlength="15">
        <br>
        <button class="action-btn" onclick="saveCallsign()">Save Callsign</button>
    </div>

    <div id="home-screen" class="hidden">
        <span style="font-size: 5rem; display:block; margin-bottom: 1rem;">üöÄ</span>
        <h2 id="welcome-msg">Welcome Back!</h2>
        
        <div style="text-align: left; margin: 20px 0;">
            <label>Total Mastery: <span id="mastery-text">0 / 1000</span></label>
            <div class="progress-bar-container">
                <div id="mastery-bar" class="progress-fill"></div>
            </div>
        </div>

        <p id="mission-brief">Ready for today's 50-question sortie?</p>
        <button class="action-btn" id="start-mission-btn">Start 50-Question Mission</button>
        <button class="action-btn" style="background: #6C5CE7;" onclick="resetProgress()">‚ö†Ô∏è Reset Progress</button>
    </div>

    <div id="quiz-container" class="hidden">
        <div class="status-bar">
            <span id="score-display">‚≠ê Score: 0</span>
            <span id="progress-display">Mission: 1/50</span>
            <button id="pause-btn" onclick="togglePause()">‚è∏Ô∏è Pause</button>
        </div>

        <div id="quiz-area">
            <div id="pause-screen" class="pause-overlay hidden">
                <h2>Mission Paused</h2>
                <button class="action-btn" onclick="togglePause()">‚ñ∂ Resume</button>
            </div>
            <div class="timer-text" id="timer-text">‚è±Ô∏è Oxygen Left: 60s</div>
            <div class="timer-container"><div class="timer-bar" id="timer-bar"></div></div>
            <div class="question-card"><div id="question-text">Loading...</div></div>
            <div class="options-grid" id="options-container"></div>
            <div class="feedback" id="feedback-text"></div>
            <div style="display:flex; justify-content:space-between; margin-top:20px;">
                <button id="prev-btn" class="nav-btn" onclick="prevQuestion()">&#8592; Prev</button>
                <button id="next-btn" class="nav-btn" onclick="manualNext()">Next &#8594;</button>
            </div>
        </div>

        <div id="results-area" class="hidden">
            <h2>üöÄ Sortie Complete!</h2>
            <p id="final-score" style="font-size: 1.5rem;"></p>
            <p id="message"></p>
            <button class="action-btn" onclick="location.reload()">Return to Base</button>
        </div>
    </div>
</div>

<script>
    // --- 1. FIREBASE CONFIGURATION ---
    // TODO: Paste your real config here!
    const firebaseConfig = {
        apiKey: "AIzaSyBQrb18KJullYToPOjwFKbJZBuNkuRP_mQ",
        authDomain: "mcas-grade3-tracker.firebaseapp.com",
        projectId: "mcas-grade3-tracker",
        storageBucket: "mcas-grade3-tracker.firebasestorage.app",
        messagingSenderId: "238267753498",
        appId: "1:238267753498:web:3b652cebbb1b5c9021dda3"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    let currentUser = null;
    let userCallsign = "Cadet"; // Default name
    let masterQuestionList = []; 
    let sessionQuestions = [];   
    let solvedIndices = [];      

    // --- 2. AUTH FLOW ---
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUser = user;
            // Check if user has a callsign saved
            db.collection('users').doc(user.uid).get().then(doc => {
                if (doc.exists && doc.data().callsign) {
                    // User has set a name before
                    userCallsign = doc.data().callsign;
                    loadUserProfile(doc.data());
                } else {
                    // First time - show setup screen
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('setup-screen').classList.remove('hidden');
                }
            });
        } else {
            currentUser = null;
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('home-screen').classList.add('hidden');
            document.getElementById('setup-screen').classList.add('hidden');
        }
    });

    function loginWithGoogle() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(e => alert(e.message));
    }

    function saveCallsign() {
        const input = document.getElementById('callsign-input').value.trim();
        if (input.length < 1) {
            alert("Please enter a name, Cadet!");
            return;
        }
        userCallsign = input;
        
        // Save to Firestore
        db.collection('users').doc(currentUser.uid).set({
            callsign: userCallsign,
            email: currentUser.email
        }, { merge: true }).then(() => {
            // Move to home
            document.getElementById('setup-screen').classList.add('hidden');
            loadUserProfile({}); // Load blank profile to start
        });
    }

    function logout() { auth.signOut(); location.reload(); }

    // Load User Mastery Data
    function loadUserProfile(data) {
        solvedIndices = data.mastered_ids || [];
        
        // Update UI with Name
        document.getElementById('username-span').innerText = userCallsign;
        document.getElementById('welcome-msg').innerText = `Welcome, ${userCallsign}!`;
        
        // Load Questions
        fetch('questions.json').then(res => res.json()).then(data => {
            masterQuestionList = data;
            updateHomeStats();
            document.getElementById('home-screen').classList.remove('hidden');
        });
    }

    function updateHomeStats() {
        const total = masterQuestionList.length;
        const mastered = solvedIndices.length;
        const percent = Math.floor((mastered / total) * 100);
        
        document.getElementById('mastery-text').innerText = `${mastered} / ${total}`;
        document.getElementById('mastery-bar').style.width = `${percent}%`;
        
        if(mastered >= total) {
            document.getElementById('mission-brief').innerText = `üéâ Incredible work, ${userCallsign}! You've conquered the galaxy!`;
            document.getElementById('start-mission-btn').disabled = true;
        } else {
            document.getElementById('mission-brief').innerText = `${userCallsign}, ready for today's mission?`;
        }
    }

    // --- 3. SESSION SETUP ---
    document.getElementById('start-mission-btn').addEventListener('click', setupSession);

    function setupSession() {
        sfx.init(); sfx.playLaunch();
        document.getElementById('home-screen').classList.add('hidden');
        document.getElementById('quiz-container').classList.remove('hidden');

        let availableIndices = masterQuestionList.map((_, i) => i).filter(i => !solvedIndices.includes(i));
        availableIndices.sort(() => Math.random() - 0.5);
        let sessionIndices = availableIndices.slice(0, 50); // 50 Questions

        sessionQuestions = sessionIndices.map(originalIndex => {
            let q = masterQuestionList[originalIndex];
            return { ...q, originalIndex: originalIndex }; 
        });

        userAnswers = new Array(sessionQuestions.length).fill(null);
        initGame();
    }

    // --- 4. GAME LOGIC ---
    const sfx = {
        ctx: null,
        init: function() { if (!this.ctx) this.ctx = new (window.AudioContext||window.webkitAudioContext)(); if(this.ctx.state==='suspended')this.ctx.resume(); },
        playTone: function(f,t,d) { if(!this.ctx)return; const o=this.ctx.createOscillator(),g=this.ctx.createGain(); o.type=t; o.frequency.value=f; g.gain.setValueAtTime(0.1,this.ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.001,this.ctx.currentTime+d); o.connect(g); g.connect(this.ctx.destination); o.start(); o.stop(this.ctx.currentTime+d); },
        playCorrect: function() { this.init(); this.playTone(880,'sine',0.1); setTimeout(()=>this.playTone(1760,'sine',0.2),100); },
        playWrong: function() { this.init(); this.playTone(150,'sawtooth',0.3); setTimeout(()=>this.playTone(100,'sawtooth',0.3),150); },
        playLaunch: function() { this.init(); if(!this.ctx)return; const o=this.ctx.createOscillator(),g=this.ctx.createGain(); o.frequency.setValueAtTime(200,this.ctx.currentTime); o.frequency.exponentialRampToValueAtTime(800,this.ctx.currentTime+0.5); g.gain.linearRampToValueAtTime(0,this.ctx.currentTime+0.5); o.connect(g); g.connect(this.ctx.destination); o.start(); o.stop(this.ctx.currentTime+0.5); }
    };

    let currentQ = 0;
    let timeLeft = 60;
    let timerInterval, hintInterval;
    let isPaused = false;
    let userAnswers = []; 

    const els = {
        qText: document.getElementById('question-text'),
        opts: document.getElementById('options-container'),
        feedback: document.getElementById('feedback-text'),
        timerTxt: document.getElementById('timer-text'),
        timerBar: document.getElementById('timer-bar'),
        progress: document.getElementById('progress-display'),
        score: document.getElementById('score-display'),
        prev: document.getElementById('prev-btn'),
        next: document.getElementById('next-btn'),
        pauseScrn: document.getElementById('pause-screen'),
        pauseBtn: document.getElementById('pause-btn')
    };

    function initGame() {
        currentQ = 0;
        document.getElementById('quiz-area').classList.remove('hidden');
        document.getElementById('results-area').classList.add('hidden');
        updateStats();
        loadQuestion();
    }

    function loadQuestion() {
        clearInterval(timerInterval); clearInterval(hintInterval);
        const q = sessionQuestions[currentQ];
        els.qText.innerText = q.question;
        els.opts.innerHTML = '';
        els.feedback.innerText = "";

        const answered = userAnswers[currentQ] !== null;

        q.options.forEach((opt, idx) => {
            const btn = document.createElement('button');
            btn.className = 'option';
            btn.innerText = opt;
            if (answered) {
                btn.disabled = true;
                if (idx === q.correct) btn.classList.add('correct-anim');
                if (userAnswers[currentQ] === idx && idx !== q.correct) btn.classList.add('wrong-anim');
            } else {
                btn.onclick = () => checkAnswer(idx, btn);
            }
            els.opts.appendChild(btn);
        });

        els.prev.disabled = (currentQ === 0);
        els.next.innerText = (currentQ === sessionQuestions.length - 1) ? "Finish" : "Next \u2192";

        if (!answered) {
            els.timerTxt.style.visibility = 'visible'; els.timerBar.parentElement.style.visibility = 'visible';
            resetTimer();
        } else {
            els.timerTxt.style.visibility = 'hidden'; els.timerBar.parentElement.style.visibility = 'hidden';
        }
        updateStats();
    }

    function checkAnswer(sel, btn) {
        clearInterval(timerInterval);
        userAnswers[currentQ] = sel;
        const q = sessionQuestions[currentQ];
        
        Array.from(document.querySelectorAll('.option')).forEach(b => b.disabled = true);

        if (sel === q.correct) {
            sfx.playCorrect();
            btn.classList.add('correct-anim');
            els.feedback.innerText = `‚úÖ Correct! Great work, ${userCallsign}!`;
            els.feedback.style.color = "#00b894";
            
            db.collection('users').doc(currentUser.uid).set({
                mastered_ids: firebase.firestore.FieldValue.arrayUnion(q.originalIndex),
                last_activity: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });

            setTimeout(autoNext, 1500);
        } else {
            sfx.playWrong();
            btn.classList.add('wrong-anim');
            els.feedback.style.color = "#fab1a0";
            let w = 30;
            els.feedback.innerText = `‚ö†Ô∏è Not quite, ${userCallsign}.\nHint: ${q.hint} (${w}s)`;
            hintInterval = setInterval(() => {
                w--;
                if (w<=0) { clearInterval(hintInterval); autoNext(); }
                else els.feedback.innerText = `‚ö†Ô∏è Not quite, ${userCallsign}.\nHint: ${q.hint} (${w}s)`;
            }, 1000);
        }
        updateStats();
    }

    function autoNext() { if(currentQ < sessionQuestions.length-1) { currentQ++; loadQuestion(); } else showResults(); }
    function manualNext() { autoNext(); }
    function prevQuestion() { if(currentQ > 0) { currentQ--; loadQuestion(); } }

    function resetTimer() {
        timeLeft = 60; isPaused = false;
        els.pauseScrn.classList.add('hidden'); els.pauseBtn.innerText = "‚è∏Ô∏è Pause";
        els.timerTxt.innerText = "Oxygen: 60s"; els.timerBar.style.width="100%"; els.timerBar.style.backgroundColor="#00b894";
        timerInterval = setInterval(() => {
            timeLeft--;
            els.timerTxt.innerText = `Oxygen: ${timeLeft}s`;
            els.timerBar.style.width = `${(timeLeft/60)*100}%`;
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                sfx.playWrong();
                userAnswers[currentQ] = -1; 
                els.feedback.innerText = `‚åõ Time's Up, ${userCallsign}!`;
                setTimeout(autoNext, 2000);
            }
        }, 1000);
    }

    function togglePause() {
        isPaused = !isPaused;
        if(isPaused) { clearInterval(timerInterval); clearInterval(hintInterval); els.pauseScrn.classList.remove('hidden'); }
        else { if(userAnswers[currentQ]===null) resetTimer(); els.pauseScrn.classList.add('hidden'); }
    }

    function updateStats() {
        const score = userAnswers.filter((a,i) => sessionQuestions[i] && a === sessionQuestions[i].correct).length;
        els.score.innerText = `Score: ${score}`;
        els.progress.innerText = `Mission: ${currentQ+1}/${sessionQuestions.length}`;
    }

    function showResults() {
        clearInterval(timerInterval); clearInterval(hintInterval);
        sfx.playLaunch();
        const score = userAnswers.filter((a,i) => a === sessionQuestions[i].correct).length;
        
        document.getElementById('quiz-area').classList.add('hidden');
        document.getElementById('results-area').classList.remove('hidden');
        document.getElementById('final-score').innerText = `Score: ${score} / ${sessionQuestions.length}`;
        
        const pct = score / sessionQuestions.length;
        let msg = `Good Practice, ${userCallsign}!`;
        if(pct > 0.8) msg = `Commander Status! Excellent work, ${userCallsign}.`;
        else if(pct > 0.5) msg = `Mission Accomplished. Keep training, ${userCallsign}!`;
        
        document.getElementById('message').innerText = msg;
    }

    function resetProgress() {
        if(confirm("Are you sure? This will forget all questions you have mastered.")) {
            db.collection('users').doc(currentUser.uid).update({
                mastered_ids: []
            }).then(() => {
                alert("Memory wiped. Starting fresh.");
                location.reload();
            });
        }
    }
</script>
</body>
</html>
